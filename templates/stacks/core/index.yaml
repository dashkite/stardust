AWSTemplateFormatVersion: "2010-09-09"
Description: Stardust Core Resources
{{#with aws.vpc}}
Parameters:
  SecurityGroups:
    Type: String
    Description: Security groups for the core stack VPC
  Subnets:
    Type: String
    Description: comma delimited list of subnet IDs for the core stack VPC
{{/with}}
Resources:
  LambdaFunctions:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      {{#if aws.vpc}}
      Parameters:
        SecurityGroups:
          Ref: SecurityGroups
        Subnets:
          Ref: Subnets
      {{/if}}
      Tags:
        - Key: Substack Type
          Value: Core Lambda Functions
        {{#each tags}}
        - Key: {{Key}}
          Value: {{Value}}
        {{/each}}
      TemplateURL: "https://{{environmentVariables.starBucket}}.s3.amazonaws.com/templates/core/lambda-functions.yaml"

  LambdaFunctionPermissions:
    Type: "AWS::CloudFormation::Stack"
    DependsOn:
      - GatewayBase
      - LambdaFunctions
    Properties:
      Parameters:
        API:
          "Fn::GetAtt": ["GatewayBase", "Outputs.API"]
        LambdaDone:
          "Fn::GetAtt": ["LambdaFunctions", "Outputs.isDone"]
      Tags:
        - Key: Substack Type
          Value: Core Lambda Function Permissions
        {{#each tags}}
        - Key: {{Key}}
          Value: {{Value}}
        {{/each}}
      TemplateURL: "https://{{environmentVariables.starBucket}}.s3.amazonaws.com/templates/core/lambda-permissions.yaml"
